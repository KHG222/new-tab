<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Greeting & Background</title>
  <style>
    body {
      transition: background 0.5s ease;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding-top: 20vh;
    }

    .morning {
      background-image: url('images/Morning.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .afternoon {
      background-image: url('images/Afternoon.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .night {
      background-image: url('images/Night.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    #greeting {
      font-size: 3rem;
    }
  </style>
</head>
<body>
  <div id="greeting">Loading...</div>

  <script>
    const GREETING_ID = "greeting";

    // Default fallback times
    let sunriseHour = 6;
    let sunriseMinute = 0;
    let noonHour = 12;
    let noonMinute = 0;
    let sunsetHour = 18;
    let sunsetMinute = 0;

    let currentLabel = null;
    let checkInterval = null;

    function changeBackgroundBasedOnCondition(condition) {
      document.body.className = ''; // Remove existing classes
      document.body.classList.add(condition); // Add new background class
    }

    function updateLabelAndSave(now) {
      const label = determineTimeOfDay(now);

      if (label !== currentLabel) {
        currentLabel = label;

        const greetingEl = document.getElementById(GREETING_ID);
        if (greetingEl) {
          greetingEl.textContent = label;
        }

        changeBackgroundBasedOnCondition(label.toLowerCase());
      }
    }

    function determineTimeOfDay(now) {
      const hour = now.getHours();
      const minute = now.getMinutes();
      const nowMins = hour * 60 + minute;
      const sunriseMins = sunriseHour * 60 + sunriseMinute;
      const noonMins = noonHour * 60 + noonMinute;
      const sunsetMins = sunsetHour * 60 + sunsetMinute;

      if (nowMins >= sunriseMins && nowMins < noonMins) {
        return "Morning";
      } else if (nowMins >= noonMins && nowMins < sunsetMins) {
        return "Afternoon";
      } else {
        return "Night";
      }
    }

    function startChecking() {
      updateLabelAndSave(new Date());

      if (checkInterval) clearInterval(checkInterval);

      checkInterval = setInterval(() => {
        updateLabelAndSave(new Date());
      }, 60 * 1000); // Every 60 seconds
    }

function fetchSunriseSunsetAndStart() {
  if (!navigator.geolocation) {
    console.warn("Geolocation not supported, using fallback times.");
    startChecking(); // fallback start immediately
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      try {
        const { latitude, longitude } = pos.coords;
        const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${latitude}&lng=${longitude}&formatted=0`);
        const data = await response.json();

        const sunriseUTC = new Date(data.results.sunrise);
        const sunsetUTC = new Date(data.results.sunset);
        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        const sunriseLocal = new Date(sunriseUTC.toLocaleString("en-US", { timeZone }));
        const sunsetLocal = new Date(sunsetUTC.toLocaleString("en-US", { timeZone }));

        sunriseHour = sunriseLocal.getHours();
        sunriseMinute = sunriseLocal.getMinutes();
        sunsetHour = sunsetLocal.getHours();
        sunsetMinute = sunsetLocal.getMinutes();

        console.log("Sunrise/sunset times set from API.");
      } catch (error) {
        console.warn("API failed, using fallback sunrise/sunset times.", error);
      } finally {
        startChecking(); // always start checking after try/catch
      }
    },
    (error) => {
      console.warn("Geolocation failed, using fallback times.", error);
      startChecking(); // fallback start immediately
    },
    { timeout: 5000 }
  );
}


    // Run on page load
    document.addEventListener("DOMContentLoaded", fetchSunriseSunsetAndStart);
  </script>
</body>
</html>